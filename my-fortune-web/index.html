<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life K-Line | äººç”Ÿèµ„äº§Kçº¿å›¾</title>
    <style>
        :root { --gold: #f0b90b; --bg: #0b0e11; --card: #1e2329; --text: #eaecef; --axis: #474d57; --green: #0ecb81; --red: #f6465d; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        /* å¸ƒå±€ä¼˜åŒ–ï¼šæ‰‹æœºç«¯å…¨å®½ï¼Œç”µè„‘ç«¯å±…ä¸­ */
        .container { width: 100%; max-width: 600px; background: var(--card); padding: 15px; border-radius: 16px; box-sizing: border-box; margin-top: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header { display: flex; justify-content: space-between; width: 100%; max-width: 600px; align-items: center; margin: 10px 0; }
        .header h2 { font-size: 20px; color: var(--gold); margin: 0; }

        .input-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        input { background: var(--bg); border: 1px solid var(--axis); color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 14px; outline: none; -webkit-appearance: none; }
        
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #main-btn { width: 100%; background: var(--gold); color: #000; padding: 15px; font-size: 16px; margin-bottom: 10px; }
        
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; display: none; }
        .secondary-btn { background: #333; color: var(--gold); border: 1px solid var(--gold); padding: 12px; font-size: 14px; }

        #canvasWrap { width: 100%; height: 350px; margin-top: 10px; background: #161a1e; border-radius: 8px; border: 1px solid var(--axis); position: relative; overflow: hidden; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        #tooltip { position: absolute; display: none; background: rgba(30, 35, 41, 0.95); border: 1px solid var(--gold); padding: 10px; border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 150px; }
        
        #shareArea { display: none; margin-top: 15px; border: 1px dashed var(--gold); padding: 15px; border-radius: 12px; background: rgba(240,185,11,0.05); }
        .instruction { font-size: 11px; color: var(--gold); margin-top: 8px; text-align: center; opacity: 0.7; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="t-title">äººç”Ÿèµ„äº§Kçº¿å›¾</h2>
        <button id="lang-btn" style="background:none; border:1px solid var(--gold); color:var(--gold); padding:5px 10px; border-radius:4px; font-size:12px;">English</button>
    </div>

    <div class="container">
        <div class="input-grid">
            <input type="number" id="year" placeholder="å‡ºç”Ÿå¹´">
            <input type="number" id="month" placeholder="æœˆ">
            <input type="number" id="day" placeholder="æ—¥">
        </div>
        <button id="main-btn">ç”Ÿæˆæˆ‘çš„ç”Ÿå‘½å‘¨æœŸè¡¨</button>
        
        <div id="canvasWrap">
            <div id="tooltip"></div>
            <canvas id="kCanvas"></canvas>
        </div>
        <div class="instruction" id="t-instr">ğŸ’¡ ç‚¹å‡»Kçº¿æŸ¥çœ‹å½“å¹´è¿åŠ¿è§£æ</div>

        <div id="shareArea">
            <div id="shareText" style="line-height:1.6; white-space:pre-wrap; font-size:14px; margin-bottom:10px;"></div>
        </div>

        <div class="action-btns" id="action-btns">
            <button class="secondary-btn" id="copy-btn">å¤åˆ¶æ–‡æ¡ˆ</button>
            <button class="secondary-btn" id="save-btn" style="background: var(--gold); color:#000;">ä¿å­˜å›¾è¡¨å›¾ç‰‡</button>
        </div>
    </div>

<script>
(function() {
    let currentLang = 'zh';
    let cachedData = [];
    
    const i18n = {
        zh: {
            title: "äººç”Ÿèµ„äº§Kçº¿å›¾", btn: "ç”Ÿæˆæˆ‘çš„ç”Ÿå‘½å‘¨æœŸè¡¨", instr: "ğŸ’¡ ç‚¹å‡»Kçº¿æŸ¥çœ‹å½“å¹´è¿åŠ¿è§£æ",
            yPlace: "å‡ºç”Ÿå¹´", mPlace: "æœˆ", dPlace: "æ—¥", copyBtn: "å¤åˆ¶æ–‡æ¡ˆ", saveBtn: "ä¿å­˜å›¾ç‰‡",
            tags: ["è´¢å¯Œä¸»å‡æµª", "åº•éƒ¨ç­‘åº•", "æ½œé¾™åœ¨æ¸Š", "é€†åŠ¿ç¿»ç›˜"],
            tpl: "ğŸ“Š æˆ‘çš„ã€äººç”ŸKçº¿å›¾ã€‘ï¼š\nâœ¨ æ ¸å¿ƒçŠ¶æ€ï¼š#{tag}\nğŸš€ è´¢å¯Œçˆ†å‘æœŸï¼š{year}å¹´ï¼",
            analysis: [
                { k: "å¤§æ˜¾èº«æ‰‹", d: "è¿åŠ¿å¦‚è™¹ï¼Œé€‚åˆä¸»åŠ¨å‡ºå‡»ã€‚" },
                { k: "åšç§¯è–„å‘", d: "ç¨³æ­¥ä¸Šå‡ï¼Œå¤šå¹´è€•è€˜è§æˆæ•ˆã€‚" },
                { k: "è›°ä¼è“„åŠ¿", d: "ä½ä½æ¨ªç›˜ï¼Œå®œå­¦ä¹ è¿›ä¿®è§‚æœ›ã€‚" },
                { k: "è°¨é˜²æ³¢åŠ¨", d: "é«˜ä½éœ‡è¡ï¼Œæ³¨æ„å®ˆè´¢é˜²é£é™©ã€‚" },
                { k: "é€†å¢ƒé‡ç”Ÿ", d: "è§¦åº•åå¼¹ï¼Œè¿æ¥å…³é”®è½¬æŠ˜ç‚¹ã€‚" },
                { k: "é¡ºåŠ¿è€Œä¸º", d: "å€ŸåŠ›ä½¿åŠ›ï¼Œäº‹åŠåŠŸå€ä¹‹å¹´ã€‚" }
            ]
        },
        en: {
            title: "Life Asset K-Line", btn: "Generate My Life Chart", instr: "ğŸ’¡ Tap bars for year analysis",
            yPlace: "Year", mPlace: "Mon", dPlace: "Day", copyBtn: "Copy Text", saveBtn: "Save Image",
            tags: ["Bullish Surge", "Bottoming", "Rising Star", "Turning Point"],
            tpl: "ğŸ“Š My Life K-Line:\nâœ¨ Status: #{tag}\nğŸš€ Peak Era: Year {year}!",
            analysis: [
                { k: "Great Success", d: "Luck is soaring, take action." },
                { k: "Steady Growth", d: "Efforts finally paying off." },
                { k: "Preparation", d: "Stay low and keep learning." },
                { k: "Caution", d: "High volatility, stay defensive." },
                { k: "Rebirth", d: "Market bottomed, turning point." },
                { k: "Go with Flow", d: "Half effort, twice result." }
            ]
        }
    };

    function mulberry32(a) {
        return function() {
            var t = a += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }

    const langBtn = document.getElementById('lang-btn');
    const mainBtn = document.getElementById('main-btn');
    const canvas = document.getElementById('kCanvas');
    const tooltip = document.getElementById('tooltip');

    langBtn.addEventListener('click', () => {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        langBtn.innerText = currentLang === 'zh' ? 'English' : 'ä¸­æ–‡';
        document.getElementById('t-title').innerText = i18n[currentLang].title;
        mainBtn.innerText = i18n[currentLang].btn;
        document.getElementById('t-instr').innerText = i18n[currentLang].instr;
        document.getElementById('year').placeholder = i18n[currentLang].yPlace;
        document.getElementById('month').placeholder = i18n[currentLang].mPlace;
        document.getElementById('day').placeholder = i18n[currentLang].dPlace;
        document.getElementById('copy-btn').innerText = i18n[currentLang].copyBtn;
        document.getElementById('save-btn').innerText = i18n[currentLang].saveBtn;
    });

    mainBtn.addEventListener('click', () => {
        const yVal = document.getElementById('year').value;
        if (!yVal) return;
        
        const birthYear = parseInt(yVal);
        const mVal = document.getElementById('month').value || 1;
        const dVal = document.getElementById('day').value || 1;
        const seedValue = birthYear + parseInt(mVal) * 31 + parseInt(dVal);
        const seededRandom = mulberry32(seedValue);

        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        // å…³é”®ï¼šé€‚é…ç§»åŠ¨ç«¯çš„é«˜æ¸…å±æ¸²æŸ“
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        const w = rect.width;
        const h = rect.height;
        const pad = { top: 40, right: 20, bottom: 40, left: 45 };
        const cW = w - pad.left - pad.right;
        const cH = h - pad.top - pad.bottom;

        // ç»˜åˆ¶èƒŒæ™¯ï¼ˆä¸ºäº†å¯¼å‡ºå›¾ç‰‡æ—¶æœ‰èƒŒæ™¯é¢œè‰²ï¼‰
        ctx.fillStyle = "#161a1e";
        ctx.fillRect(0,0,w,h);

        ctx.strokeStyle = "#474d57";
        ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, h-pad.bottom); ctx.lineTo(w-pad.right, h-pad.bottom); ctx.stroke();

        let curY = cH * 0.7;
        let peakYear = birthYear;
        let highestH = Infinity;
        cachedData = [];

        for (let i = 0; i < 40; i++) {
            const x = pad.left + i * (cW / 40) + (cW / 80);
            const move = Math.sin(seedValue * 0.1 + i * 0.5) * 20 + (seededRandom() - 0.5) * 40;
            const open = curY;
            const close = curY - move;
            const drawO = Math.min(Math.max(open, 0), cH) + pad.top;
            const drawC = Math.min(Math.max(close, 0), cH) + pad.top;
            const high = Math.min(drawO, drawC) - seededRandom() * 8;
            const low = Math.max(drawO, drawC) + seededRandom() * 8;

            const analysisIdx = Math.floor(seededRandom() * i18n.zh.analysis.length);
            cachedData.push({ x, open: drawO, close: drawC, year: birthYear + i, aIdx: analysisIdx });

            const isUp = close < open;
            ctx.strokeStyle = ctx.fillStyle = isUp ? "#0ecb81" : "#f6465d";
            ctx.beginPath(); ctx.moveTo(x, high); ctx.lineTo(x, low); ctx.stroke();
            const bW = Math.max((cW / 40) * 0.6, 3);
            ctx.fillRect(x - bW/2, Math.min(drawO, drawC), bW, Math.abs(drawO - drawC) + 1);

            if (high < highestH) { highestH = high; peakYear = birthYear + i; }
            curY = close;

            if ((birthYear + i) % 10 === 0) {
                ctx.fillStyle = "#707a8a";
                ctx.font = "10px Arial";
                ctx.textAlign = "center";
                ctx.fillText(birthYear + i, x, h - pad.bottom + 15);
            }
        }
        
        document.getElementById('shareText').innerText = i18n[currentLang].tpl.replace("{tag}", i18n[currentLang].tags[seedValue % 4]).replace("{year}", peakYear);
        document.getElementById('shareArea').style.display = 'block';
        document.getElementById('action-btns').style.display = 'grid';
    });

    // äº¤äº’è§£æ
    canvas.addEventListener('click', (e) => {
        if (cachedData.length === 0) return;
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        let closest = cachedData.reduce((prev, curr) => Math.abs(curr.x - mouseX) < Math.abs(prev.x - mouseX) ? curr : prev);

        if (Math.abs(closest.x - mouseX) < 15) {
            const baseO = cachedData[0].open;
            const change = (((baseO - closest.close) / baseO) * 100).toFixed(1);
            const info = i18n[currentLang].analysis[closest.aIdx];
            tooltip.style.display = "block";
            tooltip.style.left = (closest.x > rect.width - 160 ? closest.x - 165 : closest.x + 10) + "px";
            tooltip.style.top = "40px";
            tooltip.innerHTML = `<b style="color:var(--gold)">${closest.year}å¹´ Â· ${info.k}</b><br><span style="font-size:11px">${info.d}</span><br>å˜åŠ¨: ${change >= 0 ? '+':''}${change}%`;
        } else { tooltip.style.display = "none"; }
    });

    // å¤åˆ¶åŠŸèƒ½
    document.getElementById('copy-btn').addEventListener('click', () => {
        const el = document.createElement('textarea');
        el.value = document.getElementById('shareText').innerText;
        document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        alert(i18n[currentLang].copyOk);
    });

    // ä¸€é”®ä¿å­˜å›¾ç‰‡åŠŸèƒ½
    document.getElementById('save-btn').addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = `Life_KLine_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
})();
</script>
</body>
</html>